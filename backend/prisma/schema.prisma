generator client {
    provider      = "prisma-client-js"
    binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum WorkspaceRole {
    ADMIN
    OWNER
    EDITOR
    VIEWER
}

enum JobStatus {
    PENDING
    RUNNING
    SUCCESS
    FAILED
}

enum JobType {
    CODE_EXECUTION
    INDEX_WORKSPACE
    AUDIT_LOG
}

model User {
    id           String  @id @default(uuid())
    email        String  @unique
    passwordHash String
    name         String
    isActive     Boolean @default(true)

    projects Project[] @relation("OwnerProjects")

    memberships  WorkspaceMember[] @relation("UserMemberships")
    invitedUsers WorkspaceMember[] @relation("UserInvitations")

    refreshTokens RefreshToken[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Project {
    id          String  @id @default(uuid())
    name        String
    description String?
    ownerId     String

    owner      User        @relation("OwnerProjects", fields: [ownerId], references: [id])
    workspaces Workspace[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([ownerId])
}

model Workspace {
    id        String @id @default(uuid())
    name      String
    projectId String

    project Project           @relation(fields: [projectId], references: [id])
    members WorkspaceMember[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([projectId])
}

model WorkspaceMember {
    id          String        @id @default(uuid())
    workspaceId String
    userId      String
    role        WorkspaceRole
    invitedById String?

    workspace Workspace @relation(fields: [workspaceId], references: [id])

    user      User  @relation("UserMemberships", fields: [userId], references: [id])
    invitedBy User? @relation("UserInvitations", fields: [invitedById], references: [id])

    joinedAt DateTime @default(now())

    @@unique([workspaceId, userId])
    @@index([userId])
}

model RefreshToken {
    id        String   @id @default(uuid())
    userId    String
    tokenHash String
    revoked   Boolean  @default(false)
    expiresAt DateTime

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([userId])
}

model Job {
    id             String       @id @default(uuid())
    type           JobType
    payload        Json
    status         JobStatus    @default(PENDING)
    retryCount     Int          @default(0)
    maxRetries     Int          @default(3)
    idempotencyKey String       @unique
    lockedAt       DateTime?
    result         Json?
    createdAt      DateTime     @default(now())
    updatedAt      DateTime     @updatedAt
    jobAttempts    JobAttempt[]
}

model JobAttempt {
    id            String    @id @default(uuid())
    jobId         String
    attemptNumber Int
    errorMessage  String?
    startedAt     DateTime  @default(now())
    finishedAt    DateTime?

    job Job @relation(fields: [jobId], references: [id])

    @@index([jobId])
}
